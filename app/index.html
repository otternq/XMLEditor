<!DOCTYPE html>
<html>

    <script src="http://d3js.org/d3.v3.min.js"></script>

    <style type="text/css">
        #editor { 
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            width:500px;
            height: 500px;
        }

        #editorSettings {
            position: absolute;
            top: 510px;
            left: 0px;
        }

        #graph {
            position:absolute;
            top: 0px;
            left: 525px;
        }
        
        .node {
          stroke: #fff;
          stroke-width: 2px;
        }

        .link {
          fill: none;
          stroke: #000;
        }

    </style>

    <body>
            <div id="data"></div>

            <div id="editor"></div>
            <div id="editorSettings">
                <input type="text" size="85" name="url" placeholder="API URL" />
                <input type="submit" name="submit" value="Search" />
            </div>
            
            <script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
            <script>
                var editor = ace.edit("editor");
                editor.setTheme("ace/theme/monokai");
                editor.getSession().setMode("ace/mode/javascript");
            </script>
            
            <div id="graph"></div>
            <script type="text/javascript">

            var w = 960,
            h = 500,
            root = {id: 0, content: 'root content', nType: "root", edge: null, children: []},
            data = [root],
            tree = d3.layout.tree().size([w - 20, h - 20]),
            diagonal = d3.svg.diagonal(),
            duration = 750,
            timer = setInterval(update, duration);

            var graph = simpleJSON(data);

            var editorString = toXML(graph, 0);

            editor.getSession().setValue(editorString);

            var vis = d3.select("#graph").append("svg")
                .attr("width", w)
                .attr("height", h)
                .append("g")
                .attr("transform", "translate(10, 10)");

            vis.selectAll("circle")
                .data(tree(root))
              .enter().append("circle")
                .attr("class", "node")
                .attr("r", 3.5)
                .attr("cx", x)
                .attr("cy", y)
                .on("click", click)
                .on("mouseover", mouseover);

            function randomNode() {
                if (data.length >= 5) return clearInterval(timer);
                    
                    addNode(~~(Math.random() * data.length), "test", "node");

                    return true;


                    
                  // Add a new datum to a random parent.
                  var d = {id: data.length, content: 'test'}, parent = data[~~(Math.random() * data.length)];
                  if (parent.children) parent.children.push(d); else parent.children = [d];
                  data.push(d);
            }

            function addNode(parent, tempContent, nType, nEdge) {
                var d = {
                    id: data.length,
                    nType: nType,
                    content: tempContent,
                    edge: nEdge
                }, 
                parent = data[parent];

                if (parent.children) { 
                    parent.children.push(d); 
                } else { 
                    parent.children = [d] 
                };

                data.push(d);

                var graph = simpleJSON(data);

                var editorString = toXML(graph, 0);

                editor.getSession().setValue(editorString);
            }

                
            function update() {

                // Compute the new tree layout. We'll stash the old layout in the data.
                var nodes = tree.nodes(root);

                // Update the nodes…
                var node = vis.selectAll("circle.node")
                  .data(nodes, function(d) { return d.id; });

                // Enter any new nodes at the parent's previous position.
                node.enter().append("circle")
                  .attr("class", "node")
                  .attr("r", 7)
                  .attr("cx", function(d) { return d.parent.x0; })
                  .attr("cy", function(d) { return d.parent.y0; })
                  //.style("fill", function(d) { return d.children ? "lightsteelblue" : "#fff"; })
                  .on("click", click)
                  .on("mouseover", mouseover);

                // Transition nodes to their new position.
                node.transition()
                  .duration(duration)
                  .attr("cx", x)
                  .attr("cy", y);

                // Update the links…
                var link = vis.selectAll("path.link")
                  .data(tree.links(nodes), function(d) { return d.target.id; });

                // Enter any new links at the parent's previous position.
                link.enter().insert("path", "circle")
                  .attr("class", "link")
                  .attr("d", function(d) {
                    var o = {x: d.source.x0, y: d.source.y0};
                    return diagonal({source: o, target: o});
                  });
                  //.on("click", click);

                // Transition links to their new position.
                link.transition()
                  .duration(duration)
                  .attr("d", diagonal);
            }

            function x(d) {
              return d.x0 = d.x;
            }

            function y(d) {
              return d.y0 = d.y;
            }

            function mouseover(d) {
                document.getElementById("data").innerHTML = d.id;
            }

            function click(d) {
                console.log("Clicked = id:" + d.id + " content: " + d.content );

                var content = prompt("Content", "default content");
                var nodeType = prompt("Node Type:", "node");
                var edge = prompt("Edge value:", "1");

                addNode(
                    d.id,
                    content,
                    nodeType,
                    edge
                );

                update();

            }

            function simpleJSON(d3Data) {
                var data = getMinData(d3Data[0]);
                
                data.nodeType = d3Data[0]['nType'];
                data.children = simpleJSONAux(d3Data[0].children);
                
                return data;
            }

            function simpleJSONAux(d3Data) {
                var data = Array(); 
                for (var i = 0; i < d3Data.length; i++) {

                    //console.log(d3Data[i]);
                    
                    data[i] = getMinData(d3Data[i]);
                    data[i].nodeType = d3Data[i]['nType'];

                    data[i].edge = d3Data[i]['edge'];

                    if (d3Data[i].children) {
                        data[i].children = simpleJSONAux(d3Data[i].children);
                    }
                    
                }
                
                return data;
            }

            function toXML(data, depth) {

                var indent = "";

                for(var i = 0; i < depth; i++) {
                    indent += "\t";
                }

                var value = indent + "<node nID=\""+ data.id +"\" type=\""+ data.nodeType +"\">\n";

                if (data.edge !== undefined) {
                    value += indent + "\t<edge><value>"+ data.edge +"</value></edge>\n";
                }

                if (data.children !== undefined) {
                    //console.log(data.children.length);
                    
                    for (var i = 0; i < data.children.length; i++) {
                        value += toXML(data.children[i], depth + 1);
                    }
                }

                value += indent + "</node>\n";

                return value;
            }


            function getMinData(data) {
                if (data) {
                    return {
                        id: data.id,
                        content: data.content
                    }
                } return undefined;
            }

    </script>
    </body>

</html>